#!/bin/bash

DIRREC="$GRUPO"/rec/

# $1: Mensaje a loguear ; $2: Tipo del mensaje
function log {
    $DIRBIN/LOGEP INITEP "$1" "$2"
}

seguir=true
trap ctrl_c INT

function ctrl_c {
	echo "Finalizando..."
	seguir=false
}

function loop {
	contador=1
	while ( $seguir )
	do
		log "Demonep ciclo nro. $contador" "INFO"
		contador=$(( contador + 1 ))
		IFS='
		'
		for archivo in $(ls $DIRREC)
		do
			valido="true"
			log "Archivo detectado: $archivo" "INFO"

			# Validar que el archivo sea texto
			if file "$DIRREC$archivo" | grep -vq text$; then
				# Es Binario
				log "Archivo rechazado, motivo no es un archivo de texto." "INFO"
				valido="false"
			fi

			# Validar que el archivo no este vacio
			if [ ! -s "$DIRREC$archivo" ]; then
				log "Archivo rechazado, motivo: archivo vacio." "INFO"
				valido="false"
			fi

			# Validar formato del archivo
			# ejecutado_<año_presupuestario>_<cod_provincia>_<aniomesdia>.csv
			# ejecutado_2016_1_20151222
			formato_valido="true"
			ejec=$(echo "$archivo" | cut -d_ -f1)
			anio=$(echo "$archivo" | cut -d_ -f2)
			codigo=$(echo "$archivo" | cut -d_ -f3)
			fecha=$(echo "$archivo" | cut -d_ -f4 | cut -d. -f1)

			if [ $ejec != "ejecutado" ]; then
				formato_valido="false"
				log "Archivo rechazado, motivo: formato de nombre incorrecto." "INFO"
			fi

			if [ $anio != $(date +%Y) ]; then
				formato_valido="false"
				log "Archivo rechazado, motivo: año $anio incorrecto." "INFO"
			fi
			cat "$DIRMAE/provincias.csv" | grep -q $codigo
			if [ $? -eq 1 ]; then
				formato_valido="false"
				log "Archivo rechazado, motivo: provincia $codigo incorrecta." "INFO"
			fi

			if [ $fecha ]; then
				# Regex compleja. Lo que hago es convertir el formato de aaaammdd a mm/dd/aaaa para poder validar con date
				# TODO(tomas) Ver si se puede sacar el cuarto argumento
				formato_pedido=$(echo $fecha | sed 's/\([0-9]\{4\}\)\([0-9]\{2\}\)\([0-9]\{2\}\)\([0-9]*\)/\2\/\3\/\1\4/')
				date "+%m/%d/%Y" -d $formato_pedido > /dev/null  2>&1
 				if [ $? -ne 0 ]; then
 					formato_valido="false"
 					log "Archivo rechazado, motivo: fecha $fecha incorrecta." "INFO"
 				fi
			fi

			if [ $valido == "true" ] && [ $formato_valido == "true" ]; then
				# TODO(tomas) llamar al movep DIRNOK
				log "Archivo aceptado" "INFO"
			else
				# TODO(tomas) llamar al movep DIROK
				log "Archivo rechazado" "INFO"
			fi

		done
		sleep 30
	done
}

# Cuerpo principal
if ! [ -f "$DIRCONF/INSTALEP.conf" ] ; then
    echo "EPLAM no está adecuadamente instalado en el sistema. Ejecute INSTALEP."
    return $ERROR
fi

loop
